name: CarLot-Manager CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  # 1ï¸âƒ£ Build & Push Docker
  docker:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          IMAGE_NAME="${{ env.DOCKER_USERNAME }}/carlot-app:latest"
          docker build -t $IMAGE_NAME ./docker
          docker push $IMAGE_NAME

  # 2ï¸âƒ£ Terraform - Provision Infrastructure
  terraform:
    name: Terraform Provisioning
    runs-on: ubuntu-latest
    needs: docker
    outputs:
      master_ip: ${{ steps.tf_output.outputs.master_ip }}
      worker_ips: ${{ steps.tf_output.outputs.worker_ips }}
      ssh_key: ${{ steps.tf_output.outputs.ssh_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init & Apply
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve
          
      - name: Save Terraform State
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/
          retention-days: 1

      - name: Extract Terraform Outputs
        id: tf_output
        run: |
          cd terraform
          # Get master IP (first element of instance_ips array)
          MASTER_IP=$(terraform output -json instance_ips | jq -r '.[0]')
          # Get worker IPs (remaining elements)
          WORKER_IPS=$(terraform output -json instance_ips | jq -r '.[1:] | join(" ")')
          # Get SSH key
          SSH_KEY=$(terraform output -raw ssh_private_key)
          
          echo "Master IP: $MASTER_IP"
          echo "Worker IPs: $WORKER_IPS"
          
          echo "master_ip=$MASTER_IP" >> $GITHUB_OUTPUT
          echo "worker_ips=$WORKER_IPS" >> $GITHUB_OUTPUT
          echo "ssh_key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_KEY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Save SSH Key
        run: |
          mkdir -p /tmp
          echo "${{ steps.tf_output.outputs.ssh_key }}" > /tmp/generated_key.pem
          chmod 400 /tmp/generated_key.pem

      - name: Upload SSH Key as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-key
          path: /tmp/generated_key.pem
          retention-days: 1

  # 3ï¸âƒ£ Ansible - Setup Kubernetes Cluster
  ansible:
    name: Ansible Cluster Setup
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SSH Key
        uses: actions/download-artifact@v4
        with:
          name: ssh-key
          path: /tmp

      - name: Set SSH Key Permissions
        run: chmod 400 /tmp/generated_key.pem

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass python3-pip jq

      - name: Generate Inventory
        run: |
          MASTER_IP="${{ needs.terraform.outputs.master_ip }}"
          WORKER_IPS="${{ needs.terraform.outputs.worker_ips }}"
          
          echo "Master IP: $MASTER_IP"
          echo "Worker IPs: $WORKER_IPS"
          
          # Generate inventory with master and worker IPs
          python3 ansible/generate_inventory.py $MASTER_IP $WORKER_IPS
          
          # Display generated inventory
          echo "Generated inventory:"
          cat ansible/inventory.ini

      - name: Wait for SSH to be ready
        run: |
          MASTER_IP="${{ needs.terraform.outputs.master_ip }}"
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/generated_key.pem ubuntu@$MASTER_IP "echo SSH Ready" 2>/dev/null; then
              echo "SSH is ready"
              break
            fi
            echo "Waiting for SSH... ($i/30)"
            sleep 10
          done

      - name: Run Ansible Playbook
        run: ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

      - name: Fetch kubeconfig from master
        run: |
          MASTER_IP="${{ needs.terraform.outputs.master_ip }}"
          scp -o StrictHostKeyChecking=no -i /tmp/generated_key.pem ubuntu@$MASTER_IP:~/.kube/config $GITHUB_WORKSPACE/kubeconfig
          chmod 644 $GITHUB_WORKSPACE/kubeconfig

      - name: Upload kubeconfig as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: ${{ github.workspace }}/kubeconfig
          retention-days: 1

      - name: Wait for Kubernetes cluster to be ready
        run: |
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig
          kubectl config set-cluster kubernetes --server=https://${{ needs.terraform.outputs.master_ip }}:6443 --insecure-skip-tls-verify=true
          retries=0
          until kubectl get nodes --no-headers 2>/dev/null | awk '{print $2}' | grep -vq "NotReady"; do
            if [ $retries -ge 20 ]; then
              echo "Cluster not ready after 20 retries"
              kubectl get nodes || true
              exit 1
            fi
            echo "Waiting for cluster to be ready... ($retries/20)"
            sleep 15
            retries=$((retries+1))
          done
          echo "Cluster is ready!"
          kubectl get nodes

  # 4ï¸âƒ£ Helm Deployment + Load Balancer Info
  helm:
    name: Helm Deployment
    runs-on: ubuntu-latest
    needs: [terraform, ansible]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: terraform/

      - name: Download kubeconfig
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig
          path: .

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest

      - name: Configure kubeconfig
        run: |
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig
          kubectl config set-cluster kubernetes --server=https://${{ needs.terraform.outputs.master_ip }}:6443 --insecure-skip-tls-verify=true
          kubectl get nodes

      - name: Helm upgrade/install
        run: |
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig
          RELEASE_NAME="carlot-app"
          CHART_PATH="./helm/car-lot"
          NAMESPACE="default"
          helm upgrade --install $RELEASE_NAME $CHART_PATH --namespace $NAMESPACE --create-namespace --wait --timeout 5m

      - name: Verify Deployment
        run: |
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig
          kubectl get pods -n default
          kubectl get svc -n default

      - name: Helm release status
        run: |
          export KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig
          helm status carlot-app --namespace default

      - name: Setup Terraform for Output
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get ALB DNS from Terraform
        id: alb_info
        run: |
          cd terraform
          terraform init -backend=false
          ALB_DNS=$(terraform output -raw alb_dns_name)
          echo "ALB DNS: $ALB_DNS"
          echo "alb_url=http://$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Display Application URL
        env:
          ALB_URL: ${{ steps.alb_info.outputs.alb_url }}
        run: |
          echo "=========================================="
          echo "ðŸš€ Deployment Complete!"
          echo "=========================================="
          echo "Access your CarLot Manager at:"
          echo "$ALB_URL"
          echo "=========================================="
          echo "Note: It may take 2-3 minutes for the ALB to become healthy"
